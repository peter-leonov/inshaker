<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width"/>
	<title>tests for ClientStorage</title>
	<script src="tests.common.js" type="text/javascript"></script>
	
	<script type="text/javascript" src="../src/core/prototype.js"></script>
	<script type="text/javascript" src="../src/modules/client-storage.js"></script>
</head>
<body>
<script type="text/javascript">
Tests.test(function (t)
{
	t.test('prerequisites', function (t)
	{
		t.mayFail()
		
		t.ok(window.localStorage, 'localStorage')
		t.ok(window.globalStorage, 'globalStorage')
		t.ok(document.body.addBehavior, 'addBehavior')
	})
	
	
	function run (t, S)
	{
		t.test(S.className, function (t)
		{
			t.parallel(1)
			
			var storage = new S()
			
			if (!storage.init())
			{
				t.log('not supported')
				return
			}
			
			t.test('data', function (t)
			{
				function ready ()
				{
					storage.clear()
					
					t.eq(storage.set('a', 1), 1, 'set a')
					t.eq(storage.set('b', 2), 2, 'set b')
					t.eq(storage.set('c', 3), 3, 'set c')
					
					t.eq(storage.get('a'), '1', 'get a')
					t.eq(storage.get('b'), '2', 'get b')
					t.eq(storage.get('c'), '3', 'get c')
					t.eq(storage.get('d'), null, 'get d')
					
					t.like(storage.length(), 3, 'length')
					t.like(storage.keys().sort(), ['a', 'b', 'c'], 'keys')
					
					t.eq(storage.remove('b'), '2', 'remove b')
					t.eq(storage.get('b'), null, 'get b after remove')
					t.like(storage.length(), 2, 'length after remove')
					t.like(storage.keys().sort(), ['a', 'c'], 'keys after remove')
					
					t.eq(storage.remove('b'), null, 'remove b after remove')
					
					t.like(storage.clear().sort(), ['a', 'c'], 'clear')
					t.eq(storage.get('a'), null, 'get a after clear')
					t.eq(storage.get('b'), null, 'get b after clear')
					t.eq(storage.get('c'), null, 'get c after clear')
					t.like(storage.length(), 0, 'length after clear')
					t.like(storage.keys().sort(), [], 'keys after clear')
					
					
					storage.set(1, 'a')
					t.eq(storage.get(1), 'a', 'special case name "1"')
					storage.set('key', 'a')
					t.eq(storage.get('key'), 'a', 'special case name "key"')
					storage.set('contentEditable', 'a')
					t.eq(storage.get('contentEditable'), 'a', 'special case name "contentEditable"')
					storage.set('parentNode', 'a')
					t.eq(storage.get('parentNode'), 'a', 'special case name "parentNode"')
					storage.set('bottomMargin', 'a')
					t.eq(storage.get('bottomMargin'), 'a', 'special case name "bottomMargin"')
					t.like(storage.keys().sort(), ['1', 'key', 'contentEditable', 'parentNode', 'bottomMargin'].sort(), 'keys')
					
					t.done()
				}
				storage.ready(t.wrap(ready))
				
				t.wait(10000)
			})
			
			t.test('persistency', function (t)
			{
				function ready ()
				{
					t.eq(storage.set('persistent', 'old'), 'old', 'set persistent key')
					t.eq(storage.get('persistent'), 'old', 'get persistent key')
					
					var iframe = document.createElement('iframe')
					document.body.appendChild(iframe)
					
					var prefix = /^(.+\/)/.exec(window.location.href)[0]
					iframe.src = prefix + 'client-storage-helper.html?' + S.className + ':persistent:new'
					
					function check ()
					{
						t.eq(storage.get('persistent'), 'new', 'get persistent key')
						
						t.done()
					}
					
					iframe.onreadystatechange = function ()
					{
						if (iframe.readyState != 'complete')
							return
						
						setTimeout(check, 100)
					}
				}
				
				storage.ready(t.wrap(ready))
				t.wait(10000)
			})
			
			t.test('ready', function (t)
			{
				function ready ()
				{
					function afterReady ()
					{
						t.pass('ready() works after onready')
						t.done()
					}
					storage.ready(t.wrap(afterReady))
				}
				
				storage.ready(t.wrap(ready))
				t.wait(10000)
			})
		})
	}
	
	for (var i = 0; i < ClientStorage.backends.length; i++)
		run(t, ClientStorage.backends[i])
})
</script>
</body>
</html>