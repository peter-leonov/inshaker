<!DOCTYPE html>
<html lang="en">
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
	<meta name="viewport" content="width=device-width"/>
	<title>Tests for findCheapestPrice()</title>
	<script src="tests.common.js" type="text/javascript"></script>
	
	<script type="text/javascript" src="/lib-0.3/core/prototype.js"></script>
	<script type="text/javascript" src="/js/common/find-cheapest-price.js"></script>
	<script type="text/javascript" src="/js/common/datafilter.js"></script>
</head>
<body>
<script type="text/javascript">
Tests.test(function (t)
{
	t.ok(findCheapestPrice, 'findCheapestPrice')
	
	function f (volumes, max)
	{
		if (!volumes.length)
			return {}
		
		if (max <= 0)
			return {}
		
		var res = findCheapestPrice({volumes: volumes}, max)
		
		var h = {}
		
		if (res.addingBottles.amount)
			h[res.addingBottles.vol] = res.addingBottles.amount
		
		for (var i = 0; i < res.bottles.length; i++)
		{
			var v = res.bottles[i][0]
			if (h[v])
				h[v]++
			else
				h[v] = 1
		}
		
		return h
	}
	
	t.test('real life examples', function (t)
	{
		function run (t, bottles, volumes)
		{
			t.log(bottles)
			
			var price = {}
			for (var i = 0, il = bottles.length; i < il; i++)
				price[bottles[i][0]] = bottles[i][1]
			
			for (var i = 0, il = volumes.length; i < il; i++)
			{
				var v = volumes[i]
				
				var min = v[1]
				v = v[0]
				
				var suggestion = f(bottles, v)
				if (!t.like(suggestion, min, v))
				{
					var sum1 = 0
					for (var k in suggestion)
						sum1 += price[k] * suggestion[k]
					
					var sum2 = 0
					for (var k in min)
						sum2 += price[k] * min[k]
					
					if (sum1 <= sum2)
						t.warn('robo is right: ' + sum1 + ' <= ' + sum2)
					else
						t.warn('robo is wrong: ' + sum1 + ' > ' + sum2)
				}
			}
		}
		
		t.test('Bacardi Superior', function (t)
		{
			var bottles = [[0.5, 641], [0.75, 991]]
			
			var volumes =
			[
				[0.4, {0.5: 1}],
				[0.5, {0.5: 1}],
				[0.51, {0.75: 1}],
				[0.75, {0.75: 1}],
				[0.76, {0.5: 2}],
				[1.0, {0.5: 2}],
				[1.5, {0.5: 3}],
				[1.75, {0.5: 2, 0.75: 1}],
				[2.25, {0.5: 3, 0.75: 1}],
				[3.0, {0.5: 6}],
				[37.5, {0.5: 75}]
			]
			
			run(t, bottles, volumes)
		})
		
		t.test('Coca-cola from dostavka.7cont.ru', function (t)
		{
			var bottles = [[0.5, 37.90], [1.0, 52.90], [2.0, 56.90]]
			
			var volumes =
			[
				[0.5, {0.5: 1}],
				[1.0, {1.0: 1}],
				[1.25, {2.0: 1}],
				[1.5, {2.0: 1}],
				[2.0, {2.0: 1}],
				[2.5, {2.0: 1, 0.5: 1}],
				[2.51, {2.0: 1, 1.0: 1}],
				[3.0, {1.0: 1, 2.0: 1}],
				[3.1, {2.0: 2}],
				[100, {2.0: 50}],
				[100.5, {2.0: 50, 0.5: 1}],
				[10001, {2.0: 5000, 1.0: 1}]
			]
			
			run(t, bottles, volumes)
		})
	})
	
	t.test('corner cases', function (t)
	{
		t.like(f([], 10), {}, 'empty volumes')
		t.like(f([[0.25, 50]], 0), {}, 'zero volume')
		t.like(f([[0.25, 50]], -1), {}, 'negative volume')
		t.like(f([[1, 0], [2, 1]], 10), {1: 10}, 'free bottle')
	})
	
	t.test('same factor', function (t)
	{
		var bottles = [[1, 1], [2, 2]]
		
		t.time('10')
		f(bottles, 10)
		var a = t.timeEnd('10')
		
		t.time('20000')
		f(bottles, 20000)
		var b = t.timeEnd('20000')
		
		t.peq((a + 10) / (b + 10), 1, 0.5, 'same timings')
	})
	
	t.test('very close factor', function (t)
	{
		var bottles = [[1, 1], [2, 1.99999999]]
		
		t.time('10')
		f(bottles, 10)
		var a = t.timeEnd('10')
		
		t.time('20000')
		f(bottles, 20000)
		var b = t.timeEnd('20000')
		
		t.peq((a + 10) / (b + 10), 1, 0.5, 'same timings')
	})
	
	t.test('fractal', function (t)
	{
		// save maximun
		var maxEntries = findCheapestPrice.maxEntries
		findCheapestPrice.maxEntries = 20000
		
		var bottles = [[1000, 1000], [100, 100], [10, 10], [1, 1], [0.1, 0.1]]
		
		t.time('10')
		f(bottles, 10)
		var a = t.timeEnd('10')
		
		t.time('1111.11')
		f(bottles, 1111.11)
		var b = t.timeEnd('1111.11')
		
		t.peq((a + 10) / (b + 10), 1, 0.5, 'same timings')
		
		// restore maximun
		findCheapestPrice.maxEntries = maxEntries
	})
	
	t.test('performance (equal factor)', function (t)
	{
		var bottles = [[1.0, 1], [2.0, 1.7], [3.0, 2.1]]
		
		var a = t.speed(function () { f(bottles, 1000) })
		t.gt(Math.round(a), 500, 'solve more than 500 times per second')
	})
})
</script>
</body>
</html>